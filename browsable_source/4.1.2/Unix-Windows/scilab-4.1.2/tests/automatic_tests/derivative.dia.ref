 
getf SCI/util/testexamples.sci
 
reinit_for_test()
 
%U=mopen('SCI/tests/automatic_tests/derivative_data.ref','rb');
 
function y=F(x)
     y=[sin(x(1)*x(2))+exp(x(2)*x(3)+x(1)) ; sum(x.^3)];
endfunction
 
if load_ref('%ans') then   bugmes();quit;end,
 
 
function y=G(x,p)
     y=[sin(x(1)*x(2)*p)+exp(x(2)*x(3)+x(1)) ; sum(x.^3)];
endfunction
 
if load_ref('%ans') then   bugmes();quit;end,
 
 
 
x = [1;2;3];[J,H] = derivative(F, x, H_form='blockmat');
 
%ans = disp(J);
 
    1095.8009    3289.4833    2193.2663  
    3.           12.          27.        
 
if load_ref('%ans') then   bugmes();quit;end,
 
 
%ans = disp(H);
 
    1092.996     3287.6648    2193.2663  
    3287.6648    9868.7896    7676.4324  
    2193.2663    7676.4324    4386.5327  
    6.           0.           0.         
    0.           12.          0.         
    0.           0.           18.        
 
if load_ref('%ans') then   bugmes();quit;end,
 
 
 
n = 3;
 
// form an orthogonal matrix :
 
nu = 0;while nu < n then  [Q,nu] = colcomp(rand(n, n));end,
 
for i = [1,2,4],
  [J,H] = derivative(F, x, order=i, H_form='blockmat', Q=Q);
  mprintf('order= %d \n', i);
  disp(H);
end,
order= 1 
 
    1092.9259    3287.6107    2193.2129  
    3287.6299    9868.6462    7676.2798  
    2193.1995    7676.288     4386.3824  
    6.0001578  - 0.0000617    0.0001652  
    0.0000884    12.000037    0.0000295  
    0.0000610    0.0000942    18.000015  
order= 2 
 
    1092.9961    3287.665     2193.2665  
    3287.665     9868.7896    7676.4327  
    2193.2666    7676.4327    4386.5332  
    6.0000001  - 0.0000002    9.435D-08  
    9.004D-09    12.        - 0.0000001  
    6.646D-08  - 1.797D-08    18.        
order= 4 
 
    1092.996     3287.6647    2193.2663  
    3287.6647    9868.7891    7676.4321  
    2193.2663    7676.4321    4386.5326  
    6.           4.730D-10    1.685D-10  
    4.262D-10    12.        - 5.375D-10  
    2.104D-10  - 5.567D-10    18.        
 
 
p = 1;h = 0.001;
 
[J,H] = derivative(list(G, p), x, h, 2, H_form='hypermat');
 
disp(H);
 
(:,:,1)
 
    1092.9963    3287.6702    2193.2681  
    3287.6702    9868.8187    7676.4535  
    2193.2681    7676.4535    4386.5385  
(:,:,2)
 
    6.           0.         - 1.776D-09  
    0.           12.        - 1.776D-09  
  - 1.776D-09  - 1.776D-09    18.        
 
[J,H] = derivative(list(G, p), x, h, 4, Q=Q);
 
%ans = disp(H);
 
 
         column 1 to 5
 
    1092.996    3287.6647    2193.2663    3287.6647    9868.7891  
    6.          3.570D-09    2.855D-09    1.835D-09    12.        
 
         column 6 to 9
 
    7676.4321    2193.2663    7676.4321    4386.5326  
    9.893D-10    3.842D-10    5.137D-13    18.        
 
if load_ref('%ans') then   bugmes();quit;end,
 
 
 
// Taylor series example:
 
dx = 0.001 * [1;1;-1];
 
[J,H] = derivative(F, x);
 
%ans = F(x + dx);
 
if load_ref('%ans') then   bugmes();quit;end,
 
 
%ans = F(x + dx) - F(x);
 
if load_ref('%ans') then   bugmes();quit;end,
 
 
%ans = F(x + dx) - F(x) - J * dx;
 
if load_ref('%ans') then   bugmes();quit;end,
 
 
%ans = F(x + dx) - F(x) - J * dx - 1/2 * H * (dx0.*. dx);
 
if load_ref('%ans') then   bugmes();quit;end,
 
 
 
// A trivial example
 
function y=f(x,A,p,w)
  , y=x'*A*x+p'*x+w;
endfunction
 
if load_ref('%ans') then   bugmes();quit;end,
 
 
// with Jacobian and Hessean given by J(x)=x'*(A+A')+p', and H(x)=A+A'.
 
A = rand(3, 3);p = rand(3, 1);w = 1;
 
x = rand(3, 1);
 
[J,H] = derivative(list(f, A, p, w), x, h=1, H_form='blockmat');
 
if load_ref('H') then   bugmes();quit;end,
 
if load_ref('J') then   bugmes();quit;end,
 
 
// Since f(x) is quadratic in x, approximate derivatives of order=2 or 4 by finite
 
// differences should be exact for all h~=0. The apparent errors are caused by
 
// cancellation in the floating point operations, so a "big" h is choosen.
 
// Comparison with the exact matrices:
 
Je = x' * (A + A') + p';
 
if load_ref('Je') then   bugmes();quit;end,
 
 
He = A + A';
 
if load_ref('He') then   bugmes();quit;end,
 
 
%ans = clean(Je - J);
 
if load_ref('%ans') then   bugmes();quit;end,
 
 
%ans = clean(He - H);
 
if load_ref('%ans') then   bugmes();quit;end,
 
 
xdel_run(winsid());
 
 
mclose(%U);
 
