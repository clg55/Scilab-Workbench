#!/bin/sh

# Scilab ( http://www.scilab.org/ ) - This file is part of Scilab
# Copyright (C) 2008 - INRIA
#
# This file must be used under the terms of the CeCILL.
# This source file is licensed as described in the file COPYING, which
# you should have received as part of this distribution.  The terms
# are also available at
# http://www.cecill.info/licences/Licence_CeCILL_V2-en.txt

if [ $# -ne 2 ]; then
    echo "Usage: sci2pdf in_xml_file out_pdf_or_ps_file"
    echo "Converts an XML document conforming to scilab.rnc to PDF"
    echo "or to PostScript."
    echo "A PostScript file is generated if out_pdf_or_ps_file ends"
    echo "with '.ps'."
    exit 1
fi

echo $2 | grep '^.*\.ps$' 1> /dev/null 2>&1
if [ $? -eq 0 ]; then
    format=-ps
else
    format=-pdf
fi

binDir=`dirname $0`

# libDir path
# ==============================================================================

if [ -e "$binDir/../../../thirdparty" ]; then
	libDir=$binDir/../../../thirdparty
elif [ -e "$binDir/../../../../../thirdparty" ]; then
	libDir=$binDir/../../../../../thirdparty
else
	echo "Don't find the thirdparty directory."
	exit 2
fi

# jar checks
# ==============================================================================

if [ ! -e "$libDir/avalon-framework.jar" ]; then
    echo "Don't find the avalon-framework.jar file."
    exit 3
fi

if [ ! -e "$libDir/batik.jar" ]; then
    echo "Don't find the batik.jar file."
    exit 4
fi

if [ ! -e "$libDir/commons-io.jar" ]; then
    echo "Don't find the commons-io.jar file."
    exit 5
fi

if [ ! -e "$libDir/commons-logging.jar" ]; then
    echo "Don't find the commons-logging.jar file."
    exit 6
fi

if [ ! -e "$libDir/jeuclid-core.jar" ]; then
    echo "Don't find the jeuclid-core.jar file."
    exit 7
fi

if [ ! -e "$libDir/fop-hyph.jar" ]; then
    echo "Don't find the fop-hyph.jar file."
    exit 8
fi

if [ ! -e "$libDir/fop.jar" ]; then
    echo "Don't find the fop.jar file."
    exit 9
fi

if [ ! -e "$libDir/jimi.jar" ]; then
    echo "Don't find the jimi.jar file."
    exit 10
fi

if [ ! -e "$libDir/sci_doc_kit.jar" ]; then
    echo "Don't find the sci_doc_kit.jar file."
    exit 11
fi

if [ ! -e "$libDir/xmlgraphics-commons.jar" ]; then
    echo "Don't find the xmlgraphics-commons.jar file."
    exit 12
fi

if [ ! -e "$libDir/js.jar" ]; then
    echo "Don't find the js.jar file."
    exit 13
fi



# This XSL style sheet fixes bugs in ../docbook_xsl/fo/htmltbl.xsl
# ==============================================================================

docbookXslDir=$binDir/../xsl

foDir=/tmp/sci2pdf_tmp
rm -rf "$foDir"
mkdir "$foDir"

baseName=`basename $1`
flatXMLFile="$foDir/$baseName"

foFile="$foDir/__doc.fo"

cp=$libDir/sci_doc_kit.jar:\
$libDir/jeuclid-core.jar:$libDir/commons-logging.jar:\
$libDir/batik.jar:$libDir/js.jar

java -cp "$cp" org.scilab.doc_kit.CopyConvert $format "$1" "$flatXMLFile"

type xsltproc 1> /dev/null 2>&1
if [ $? -eq 0 ]; then

    xsltproc -o "$foFile" \
        --stringparam paper.type A4 \
        --stringparam generate.toc "book toc,title,figure,table,example,equation part toc,title reference toc,title" \
        --stringparam toc.section.depth 3 \
        --stringparam section.autolabel 1 \
        --stringparam variablelist.as.blocks 1 \
        --stringparam shade.verbatim 1 \
            "$docbookXslDir/fo/docbook.xsl" "$flatXMLFile"

else

    java -Xmx512m -cp "$libDir/saxon.jar:$libDir/docbook-xsl-saxon.jar" \
        com.icl.saxon.StyleSheet \
        -o "$foFile" \
        "$flatXMLFile" \
        "$docbookXslDir/fo/docbook.xsl" \
        use.extensions=1 \
        graphicsize.extension=0 \
        paper.type=A4 \
        "generate.toc=book toc,title,figure,table,example,equation part toc,title reference toc,title" \
        toc.section.depth=3 \
        section.autolabel=1 \
        variablelist.as.blocks=1 \
        shade.verbatim=1

fi

type xep 1> /dev/null 2>&1
if [ $? -eq 0 ]; then
    xep -valid -fo "$foFile" $format "$2"

else
    cp2=$libDir/fop.jar:$libDir/fop-hyph.jar:$libDir/avalon-framework.jar:$libDir/commons-io.jar:$libDir/commons-logging.jar:$libDir/xmlgraphics-commons.jar:$libDir/jimi.jar:$libDir/batik.jar:$libDir/js.jar

    java -Xmx512m -cp "$cp2" org.apache.fop.cli.Main \
        -dpi 120 -r -fo "$foFile" $format "$2"

fi

rm -rf "$foDir"
